# 主应用开发

<cite>
**本文引用的文件**
- [packages/main-app/package.json](file://packages/main-app/package.json)
- [packages/main-app/vite.config.js](file://packages/main-app/vite.config.js)
- [packages/main-app/src/main.js](file://packages/main-app/src/main.js)
- [packages/main-app/src/config/microApps.js](file://packages/main-app/src/config/microApps.js)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js)
- [packages/main-app/src/router/index.js](file://packages/main-app/src/router/index.js)
- [packages/main-app/src/stores/index.js](file://packages/main-app/src/stores/index.js)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [组件详解](#组件详解)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本指南面向主应用开发者，系统讲解主应用的初始化流程、qiankun 微前端引擎集成、微应用生命周期管理、微应用配置系统、主子应用通信协调（路由同步、状态共享、事件传递）、开发与部署最佳实践，以及调试、性能优化与故障排除方法。内容基于仓库中主应用包的实际实现，确保读者能够快速上手并稳定落地。

## 项目结构
主应用位于 packages/main-app，采用 Vite + Vue3 + Pinia + Element Plus 技术栈，通过 qiankun 实现微前端集成。核心目录与职责概览如下：
- src/main.js：应用入口，负责创建 Vue 应用、注册插件、桥接通信、挂载根组件
- src/router/index.js：路由定义与守卫，支持主应用与多类子应用的路径映射
- src/stores/*：状态管理（Pinia），提供应用状态、用户状态、标签页状态等
- src/config/microApps.js：微应用配置中心，集中管理各子应用的入口、激活规则、布局选项等
- src/core/microAppManager.js：微应用管理器，封装加载、卸载、预加载、心跳检测、热更新、样式隔离清理等能力
- vite.config.js：构建与开发服务器配置，含别名、CSS 预处理器、分包策略、端口与跨域设置
- package.json：依赖与脚本定义（dev/build/preview/lint）

```mermaid
graph TB
A["入口 main.js"] --> B["路由 router/index.js"]
A --> C["状态 stores/index.js"]
A --> D["微应用配置 config/microApps.js"]
A --> E["微应用管理 core/microAppManager.js"]
E --> F["qiankun 加载/卸载"]
E --> G["样式隔离清理"]
E --> H["心跳与热更新"]
B --> I["视图 SubAppPage.vue 等"]
C --> J["用户/应用/标签页状态"]
```

图表来源
- [packages/main-app/src/main.js](file://packages/main-app/src/main.js#L1-L40)
- [packages/main-app/src/router/index.js](file://packages/main-app/src/router/index.js#L1-L130)
- [packages/main-app/src/stores/index.js](file://packages/main-app/src/stores/index.js#L1-L12)
- [packages/main-app/src/config/microApps.js](file://packages/main-app/src/config/microApps.js#L1-L110)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L1-L515)

章节来源
- [packages/main-app/package.json](file://packages/main-app/package.json#L1-L31)
- [packages/main-app/vite.config.js](file://packages/main-app/vite.config.js#L1-L40)

## 核心组件
- 应用入口与初始化
  - 创建 Vue 应用、安装路由与状态管理、注册 Element Plus 及图标组件、初始化跨应用桥接、挂载根节点
  - 将微应用管理器暴露至全局以便调试
- 路由系统
  - 定义主应用与子应用的路由映射，支持通配符路径；在前置守卫中设置加载态与激活应用，在后置守卫中维护标签页
- 状态管理
  - 使用 Pinia 并启用持久化插件，导出应用、用户、标签页等 Store 供业务模块使用
- 微应用配置
  - 统一声明各子应用的入口地址、激活规则、容器、状态、版本、预加载、类型、布局选项与自定义属性
- 微应用管理器
  - 提供加载/卸载/刷新、预加载、心跳检测、热更新、样式隔离清理、错误日志、上下线控制等能力

章节来源
- [packages/main-app/src/main.js](file://packages/main-app/src/main.js#L1-L40)
- [packages/main-app/src/router/index.js](file://packages/main-app/src/router/index.js#L1-L130)
- [packages/main-app/src/stores/index.js](file://packages/main-app/src/stores/index.js#L1-L12)
- [packages/main-app/src/config/microApps.js](file://packages/main-app/src/config/microApps.js#L1-L110)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L1-L515)

## 架构总览
主应用通过路由驱动进入子应用页面，微应用管理器根据配置与激活规则加载对应子应用（qiankun 或 iframe），并通过桥接通道传递令牌、路由基座、应用 ID 等上下文。管理器还负责生命周期监控、样式隔离清理、热更新检测与错误记录。

```mermaid
sequenceDiagram
participant U as "用户"
participant R as "路由 router/index.js"
participant M as "微应用管理 core/microAppManager.js"
participant Q as "qiankun"
participant S as "子应用"
U->>R : 导航到 /vue3/ : pathMatch
R->>M : 触发加载 appId='vue3-sub-app'
M->>Q : loadMicroApp(name=appId, entry, container, props)
Q-->>M : mountPromise 解析
M-->>R : 加载完成，状态更新
R-->>U : 渲染子应用视图
```

图表来源
- [packages/main-app/src/router/index.js](file://packages/main-app/src/router/index.js#L42-L52)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L96-L134)

## 组件详解

### 应用初始化与入口
- 初始化步骤
  - 创建 Vue 应用实例，安装路由与状态管理，注册 Element Plus 及图标组件
  - 初始化跨应用桥接，随后挂载根节点
  - 将微应用管理器挂载到全局以便调试
- 关键点
  - 插件顺序与依赖关系明确，确保状态与路由在应用层面可用
  - 全局暴露管理器便于开发期排查

章节来源
- [packages/main-app/src/main.js](file://packages/main-app/src/main.js#L1-L40)

### 路由系统与激活规则
- 路由设计
  - 主应用首页、应用管理、多实例同屏等页面
  - 子应用路由：以 /vue3/:pathMatch、/vue2/:pathMatch、/iframe/:pathMatch 匹配，meta 中携带 appId
- 激活规则
  - 在前置守卫中根据目标路由 meta/appId 设置当前激活应用
  - 在后置守卫中关闭加载态并添加标签页
- 与微应用的关系
  - 路由仅负责“进入子应用页面”，具体加载由微应用管理器按配置执行

章节来源
- [packages/main-app/src/router/index.js](file://packages/main-app/src/router/index.js#L1-L130)

### 微应用配置系统
- 配置项要点
  - id/name/entry/activeRule/container/status/version/lastModified/preload/type/layoutType/layoutOptions/props
  - props 中包含 routerBase 等关键字段，用于子应用路由基座
- 查询与更新
  - 提供按 ID、状态、类型查询与动态更新配置的能力
- 类型支持
  - 支持 vue3、vue2、iframe、link 等类型，link 类型会直接打开新窗口

章节来源
- [packages/main-app/src/config/microApps.js](file://packages/main-app/src/config/microApps.js#L1-L110)

### 微应用管理器（核心）
- 能力概览
  - 加载/卸载/刷新：支持 qiankun 与 iframe 两类子应用
  - 预加载：对满足条件的应用进行预取
  - 心跳检测：定期检查应用健康状态或向 iframe 发送 PING
  - 热更新：通过 HEAD 请求 last-modified 检测变更并自动刷新
  - 样式隔离清理：移除 qiankun 注入的样式与子应用入口相关资源
  - 错误日志：统一记录并限制数量
  - 上下线控制：动态更新配置并按需卸载
- 关键流程
  - 加载流程：校验配置与状态 -> 防重 -> 选择加载路径 -> 传入 props（token、mainRouter、bridge、appId）-> 等待挂载 -> 启动心跳/热更新
  - 卸载流程：停止心跳 -> 卸载应用或移除 iframe -> 清理容器 -> 清理样式 -> 删除记录
  - 预加载流程：筛选满足条件的应用 -> 执行预取 -> 更新预加载状态
  - 热更新流程：HEAD 请求获取 last-modified -> 比较缓存 -> 新于缓存则刷新

```mermaid
classDiagram
class MicroAppManager {
+isAppLoaded(appId) boolean
+load(appId, container, options) Promise
+unload(appId) Promise
+reload(appId) Promise
+preload(appIds) Promise
+setAppStatus(appId, status) void
+getErrorLogs(appId) Array
+clearErrorLogs() void
-startHeartbeat(appId) void
-startIframeHeartbeat(appId, iframe) void
-stopHeartbeat(appId) void
-checkLastModified(appId) Promise
-_cleanupStyles(appId) void
}
```

图表来源
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L11-L515)

章节来源
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L1-L515)

### 跨应用通信与事件传递
- 令牌与上下文传递
  - 通过 props 将 token、mainRouter、bridge、appId 等传递给子应用
- iframe 初始化
  - iframe 加载完成后通过桥接通道发送 INIT 消息，携带 token 与 appId
- 心跳与 PING
  - 对 iframe 应用周期性发送 PING，维持连接健康
- 事件通道
  - 通过桥接模块实现主子应用间的消息传递（具体实现位于桥接模块）

章节来源
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L96-L134)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L206-L220)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L364-L375)

### 开发流程与最佳实践
- 项目初始化
  - 安装依赖后，使用 dev 脚本启动本地服务（默认端口 8080）
  - 构建产物输出至 dist，静态资源目录 assets
- 路由与页面
  - 在路由中为每个子应用配置独立路径段，并在 meta 中标注 appId
  - 页面组件中通过容器占位渲染子应用
- 微应用接入
  - 在配置文件中新增/更新子应用配置，设置激活规则与容器
  - 如需预加载，开启 preload 并保证入口可达
- 状态与标签页
  - 在路由守卫中维护加载态与标签页，提升用户体验
- 构建优化
  - 通过手动分包策略将 element-plus 与 vue 生态拆分，减少首屏体积
  - CSS 预处理器注入全局变量，统一主题风格

章节来源
- [packages/main-app/package.json](file://packages/main-app/package.json#L6-L11)
- [packages/main-app/vite.config.js](file://packages/main-app/vite.config.js#L26-L38)
- [packages/main-app/src/router/index.js](file://packages/main-app/src/router/index.js#L93-L127)

## 依赖关系分析
- 外部依赖
  - Vue3、Vue Router、Pinia、Element Plus、qiankun、axios、lodash-es 等
- 内部依赖
  - main.js 依赖 router、stores、bridge、microAppManager
  - router 依赖 stores
  - microAppManager 依赖 microApps、stores、bridge
- 构建与开发
  - Vite 插件与别名配置、CSS 预处理、分包策略、开发服务器端口与跨域头

```mermaid
graph LR
P["package.json 依赖"] --> V["Vue3"]
P --> R["Vue Router"]
P --> N["Pinia"]
P --> E["Element Plus"]
P --> K["qiankun"]
MJS["src/main.js"] --> R
MJS --> N
MJS --> BR["bridge(未在本节展开)"]
MJS --> MM["microAppManager"]
MM --> MA["microApps 配置"]
MM --> ST["stores 用户/应用/标签页"]
```

图表来源
- [packages/main-app/package.json](file://packages/main-app/package.json#L12-L29)
- [packages/main-app/src/main.js](file://packages/main-app/src/main.js#L1-L35)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L1-L10)
- [packages/main-app/src/config/microApps.js](file://packages/main-app/src/config/microApps.js#L1-L10)

章节来源
- [packages/main-app/package.json](file://packages/main-app/package.json#L1-L31)
- [packages/main-app/src/main.js](file://packages/main-app/src/main.js#L1-L35)

## 性能考量
- 分包与缓存
  - 通过 Rollup manualChunks 将 element-plus 与 vue 生态独立打包，提升缓存命中率
- 样式隔离
  - 启用沙箱样式隔离，并在卸载时清理 qiankun 注入的样式与子应用入口相关资源，避免样式污染与内存泄漏
- 预加载
  - 对满足条件的应用执行预取，缩短首次加载时间
- 资源过滤
  - 排除 Element Plus/UI 的 CSS 资源，避免与主应用重复引入

章节来源
- [packages/main-app/vite.config.js](file://packages/main-app/vite.config.js#L30-L38)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L108-L120)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L288-L313)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L421-L440)

## 故障排除指南
- 常见问题定位
  - 应用未找到或已下线：检查配置中的 id、status 与入口地址
  - 容器未找到：确认容器元素存在且传入的是 DOM 而非选择器字符串
  - 重复加载：确保同一 appId 同时只加载一个实例
  - 样式污染：卸载后检查是否清理了 qiankun 注入样式与子应用入口资源
- 日志与调试
  - 查看控制台输出与错误日志队列，定位加载失败原因
  - 通过全局暴露的微应用管理器查看已加载应用与错误详情
- 热更新与心跳
  - 若热更新未生效，检查子应用入口的 last-modified 响应头与 HEAD 请求可达性
  - iframe 心跳异常时，检查桥接通道与 PING/PONG 交互

章节来源
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L52-L62)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L89-L91)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L157-L164)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L288-L313)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L392-L415)
- [packages/main-app/src/core/microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L364-L375)

## 结论
本指南基于仓库实际实现，系统梳理了主应用初始化、qiankun 集成、微应用配置与生命周期管理、路由与状态协同、跨应用通信、性能优化与故障排除等关键环节。建议在开发中遵循配置集中化、加载流程标准化、样式隔离与清理规范化、错误日志可追溯的原则，以获得稳定可靠的微前端主应用体验。

## 附录
- 开发命令
  - 启动：npm run dev（默认端口 8080）
  - 构建：npm run build
  - 预览：npm run preview
  - 代码检查：npm run lint
- 构建产物
  - 输出目录：dist
  - 静态资源目录：assets
- 调试入口
  - 全局访问微应用管理器：window.__ARTISAN_MICRO_APP_MANAGER__

章节来源
- [packages/main-app/package.json](file://packages/main-app/package.json#L6-L11)
- [packages/main-app/vite.config.js](file://packages/main-app/vite.config.js#L26-L38)
- [packages/main-app/src/main.js](file://packages/main-app/src/main.js#L36-L38)