# 热更新检测机制

<cite>
**本文档引用的文件**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js)
- [microApps.js](file://packages/main-app/src/config/microApps.js)
- [bridge.js](file://packages/main-app/src/core/bridge.js)
- [iframeLoader.js](file://packages/main-app/src/core/iframeLoader.js)
- [README.md](file://README.md)
- [package.json](file://package.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介

本文档深入解析 Artisan Base Frontend 项目中的热更新检测机制，重点分析 Last-Modified 头部检查原理、缓存管理策略和自动刷新触发逻辑。该机制通过 HTTP HEAD 请求检查子应用入口的最后修改时间，实现对 Vue 应用的自动化热更新检测。

项目采用微前端架构，支持 Vue3、Vue2、iframe 和 link 四种应用类型。热更新检测机制主要针对 Vue 应用类型，通过 qiankun 微前端框架实现子应用的动态加载和卸载。

## 项目结构

项目采用 Monorepo 架构，使用 Lerna + npm workspace 管理多个包：

```mermaid
graph TB
subgraph "项目根目录"
Root[根配置文件<br/>package.json]
Readme[项目说明<br/>README.md]
end
subgraph "核心包"
MainApp[主应用<br/>packages/main-app]
CLI[CLI 工具<br/>packages/cli]
end
subgraph "子应用包"
Vue3SubApp[Vue3 子应用<br/>packages/vue3-sub-app]
Vue2SubApp[Vue2 子应用<br/>packages/vue2-sub-app]
IframeSubApp[Iframe 子应用<br/>packages/iframe-sub-app]
end
subgraph "文档包"
UserDocs[用户文档<br/>user-docs]
end
Root --> MainApp
Root --> CLI
Root --> Vue3SubApp
Root --> Vue2SubApp
Root --> IframeSubApp
Root --> UserDocs
```

**图表来源**
- [package.json](file://package.json#L1-L50)
- [README.md](file://README.md#L62-L76)

**章节来源**
- [package.json](file://package.json#L1-L50)
- [README.md](file://README.md#L62-L76)

## 核心组件

热更新检测机制的核心组件包括：

### MicroAppManager 类
负责微应用的生命周期管理、热更新检测和状态监控。关键特性：
- Last-Modified 缓存管理
- 心跳检测机制
- 自动刷新触发逻辑
- 错误日志记录

### 应用配置管理
维护所有微应用的配置信息，包括应用类型、入口地址、状态等属性。

### 通信桥接系统
基于 postMessage 实现主应用与子应用之间的双向通信。

**章节来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L11-L31)
- [microApps.js](file://packages/main-app/src/config/microApps.js#L5-L69)

## 架构概览

```mermaid
graph TB
subgraph "主应用层"
MAM[MicroAppManager<br/>微应用管理器]
Config[配置管理<br/>microApps.js]
Bridge[通信桥接<br/>bridge.js]
end
subgraph "应用层"
VueApps[Vue 应用<br/>Vue3/Vue2]
IframeApp[Iframe 应用]
LinkApp[Link 应用]
end
subgraph "检测机制"
LMChecker[Last-Modified 检测器]
Cache[缓存管理器]
Heartbeat[心跳检测器]
end
MAM --> LMChecker
MAM --> Cache
MAM --> Heartbeat
LMChecker --> VueApps
LMChecker --> Config
Heartbeat --> Bridge
Bridge --> IframeApp
```

**图表来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L392-L415)
- [microApps.js](file://packages/main-app/src/config/microApps.js#L76-L107)

## 详细组件分析

### Last-Modified 检测器工作流程

#### checkLastModified() 方法分析

```mermaid
sequenceDiagram
participant Manager as MicroAppManager
participant Config as 配置管理器
participant Fetch as HTTP客户端
participant Cache as 缓存存储
participant App as 子应用
Manager->>Config : 获取应用配置
Config-->>Manager : 返回配置信息
Manager->>Manager : 检查应用类型(排除iframe)
alt 非iframe应用
Manager->>Fetch : 发送HEAD请求到入口URL
Fetch-->>Manager : 返回响应头信息
Manager->>Manager : 解析Last-Modified头
alt 存在Last-Modified头
Manager->>Cache : 获取缓存的时间戳
Cache-->>Manager : 返回缓存值
Manager->>Manager : 比较新旧时间戳
alt 新时间戳更大
Manager->>App : 触发应用刷新
App->>App : 卸载现有实例
App->>App : 重新加载新版本
end
Manager->>Cache : 更新缓存时间戳
end
else iframe应用
Manager->>Manager : 直接返回(不支持)
end
```

**图表来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L392-L415)

#### 时间戳比较算法

检测机制采用严格的时间比较策略：

1. **HTTP HEAD 请求**: 使用 `fetch()` API 发送 HEAD 请求，仅获取响应头信息
2. **Last-Modified 解析**: 从响应头中提取 `last-modified` 字段并转换为时间戳
3. **缓存对比**: 将新时间戳与缓存中的时间戳进行比较
4. **刷新触发**: 当新时间戳大于缓存时间戳时触发应用刷新

#### 缓存管理策略

```mermaid
flowchart TD
Start([开始检测]) --> GetConfig[获取应用配置]
GetConfig --> CheckType{检查应用类型}
CheckType --> |iframe| Return[直接返回]
CheckType --> |非iframe| SendRequest[发送HEAD请求]
SendRequest --> ParseHeader[解析Last-Modified头]
ParseHeader --> HasHeader{是否存在头信息}
HasHeader --> |否| UpdateCache[更新缓存为空值]
HasHeader --> |是| CompareTime[比较时间戳]
CompareTime --> NewHigher{新时间戳更高?}
NewHigher --> |是| TriggerReload[触发应用刷新]
NewHigher --> |否| NoAction[无操作]
TriggerReload --> UpdateCacheNew[更新缓存为新时间戳]
NoAction --> UpdateCacheNew
UpdateCache --> End([结束])
UpdateCacheNew --> End
Return --> End
```

**图表来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L396-L414)

**章节来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L392-L415)

### 心跳检测机制

#### Vue 应用心跳检测

```mermaid
sequenceDiagram
participant Timer as 定时器
participant Manager as MicroAppManager
participant App as 子应用
participant Status as 状态检查
Timer->>Manager : 每30秒触发一次
Manager->>App : 获取应用状态
App-->>Manager : 返回状态信息
Manager->>Status : 检查状态是否健康
alt 状态异常
Manager->>Manager : 标记应用为unhealthy
else 状态正常
Manager->>Manager : 继续监控
end
```

**图表来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L340-L356)

#### Iframe 应用心跳检测

```mermaid
sequenceDiagram
participant Timer as 定时器
participant Manager as MicroAppManager
participant Bridge as 通信桥接
participant Iframe as Iframe元素
participant Pong as PONG响应
Timer->>Manager : 每30秒触发一次
Manager->>Bridge : 发送PING消息
Bridge->>Iframe : postMessage(PING)
Iframe-->>Bridge : 返回PONG响应
Bridge-->>Manager : 处理PONG消息
Manager->>Manager : 更新最后响应时间
alt 超过60秒未响应
Manager->>Manager : 标记应用为unhealthy
end
```

**图表来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L364-L374)
- [iframeLoader.js](file://packages/main-app/src/core/iframeLoader.js#L215-L230)

**章节来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L340-L374)
- [iframeLoader.js](file://packages/main-app/src/core/iframeLoader.js#L215-L230)

### 应用类型支持情况

#### Vue 应用支持
- ✅ 支持 Last-Modified 热更新检测
- ✅ 支持自动刷新
- ✅ 支持预加载优化
- ✅ 支持心跳检测

#### Iframe 应用限制
- ❌ 不支持 Last-Modified 热更新检测
- ✅ 支持心跳检测机制
- ✅ 支持手动刷新
- ✅ 支持高度自适应

#### Link 应用
- ❌ 不支持热更新检测
- ❌ 不支持自动刷新
- ✅ 支持外部链接跳转

**章节来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L392-L394)
- [microApps.js](file://packages/main-app/src/config/microApps.js#L5-L69)

## 依赖关系分析

```mermaid
graph TB
subgraph "外部依赖"
Qiankun[qiankun 微前端框架]
Vue[Vue.js 框架]
Fetch[Fetch API]
end
subgraph "内部模块"
MAM[MicroAppManager]
Config[microApps配置]
Bridge[通信桥接]
Styles[样式清理]
end
subgraph "应用类型"
Vue3[Vue3应用]
Vue2[Vue2应用]
Iframe[Iframe应用]
Link[Link应用]
end
MAM --> Qiankun
MAM --> Config
MAM --> Bridge
MAM --> Styles
MAM --> Fetch
MAM --> Vue
Qiankun --> Vue3
Qiankun --> Vue2
Bridge --> Iframe
Config --> Vue3
Config --> Vue2
Config --> Iframe
Config --> Link
```

**图表来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L1-L5)
- [microApps.js](file://packages/main-app/src/config/microApps.js#L1-L4)

**章节来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L1-L5)
- [microApps.js](file://packages/main-app/src/config/microApps.js#L1-L4)

## 性能考虑

### 检测频率控制

热更新检测采用定时轮询机制，存在以下性能特征：

- **检测间隔**: 30秒执行一次
- **请求类型**: 使用 HTTP HEAD 请求，仅获取响应头信息
- **并发控制**: 每个应用独立的检测定时器
- **资源消耗**: 相对较低，主要消耗在网络请求和时间比较上

### 异常处理机制

```mermaid
flowchart TD
Request[发起HTTP请求] --> TryBlock[try块执行]
TryBlock --> Success{请求成功?}
Success --> |是| ParseHeader[解析响应头]
Success --> |否| CatchBlock[catch块处理]
ParseHeader --> HasLM{存在Last-Modified?}
HasLM --> |是| Compare[比较时间戳]
HasLM --> |否| LogWarn[记录警告]
Compare --> Newer{新时间戳更晚?}
Newer --> |是| Reload[触发刷新]
Newer --> |否| UpdateCache[更新缓存]
Reload --> UpdateCache
UpdateCache --> End[结束]
LogWarn --> End
CatchBlock --> LogError[记录错误]
LogError --> End
```

**图表来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L396-L414)

### 性能优化建议

1. **合理设置检测频率**: 根据应用更新频率调整检测间隔
2. **缓存策略优化**: 利用浏览器缓存减少不必要的请求
3. **错误重试机制**: 实现指数退避的重试策略
4. **并发控制**: 避免同时检测过多应用导致的性能问题

**章节来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L396-L414)

## 故障排除指南

### 常见问题及解决方案

#### Last-Modified 头部缺失
**现象**: 检测日志显示警告信息
**原因**: 服务器未正确设置 Last-Modified 响应头
**解决方案**: 
- 确保静态资源服务器正确配置 ETag/Last-Modified
- 检查构建工具是否生成正确的响应头
- 验证 CDN 配置是否保留响应头信息

#### 网络请求失败
**现象**: 控制台出现网络错误警告
**原因**: 网络连接问题或服务器不可达
**解决方案**:
- 检查应用入口 URL 配置
- 验证网络连接状态
- 确认服务器防火墙设置

#### 应用刷新异常
**现象**: 应用刷新后状态异常
**原因**: 卸载和重新加载过程中的状态丢失
**解决方案**:
- 确保应用具有完整的卸载生命周期
- 检查应用状态管理机制
- 验证路由状态的持久化

### 调试方法

#### 开启详细日志
```javascript
// 在开发环境中启用详细日志
console.log('[MicroAppManager] Debug mode enabled')
```

#### 检查配置状态
```javascript
// 验证应用配置
const config = getMicroApp(appId)
console.log('Application config:', config)
```

#### 监控检测结果
```javascript
// 查看检测缓存状态
console.log('LastModified cache:', microAppManager.lastModifiedCache)
```

**章节来源**
- [microAppManager.js](file://packages/main-app/src/core/microAppManager.js#L412-L413)

## 结论

Artisan Base Frontend 项目的热更新检测机制通过 Last-Modified 头部检查实现了对 Vue 应用的自动化热更新支持。该机制具有以下特点：

1. **精确性**: 基于 HTTP 响应头的精确时间比较
2. **效率性**: 使用 HEAD 请求减少数据传输量
3. **可靠性**: 完善的异常处理和错误日志记录
4. **扩展性**: 支持多种应用类型的差异化处理

对于 Iframe 应用，由于安全限制无法直接访问其响应头信息，因此采用心跳检测机制替代。这种设计既保证了安全性，又提供了有效的应用状态监控。

## 附录

### 配置选项说明

| 配置项 | 类型 | 默认值 | 描述 |
|--------|------|--------|------|
| `preload` | boolean | false | 是否预加载应用 |
| `status` | string | 'online' | 应用状态 (online/offline) |
| `type` | string | 'vue3' | 应用类型 (vue3/vue2/iframe/link) |
| `lastModified` | number | Date.now() | 最后修改时间戳 |
| `version` | string | '1.0.0' | 应用版本号 |

### 最佳实践建议

1. **生产环境部署**
   - 确保服务器正确配置 Last-Modified 响应头
   - 设置合理的检测频率避免过度请求
   - 实施错误重试和降级策略

2. **开发环境优化**
   - 使用本地开发服务器确保响应头正确设置
   - 启用详细的日志输出便于调试
   - 配置适当的缓存策略

3. **监控和告警**
   - 建立应用健康状态监控
   - 设置异常告警机制
   - 定期检查检测机制的运行状态